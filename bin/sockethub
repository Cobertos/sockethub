#!/usr/bin/env node
/**
 * This file is part of sockethub.
 *
 * Â© 2012-2013 Nick Jennings (https://github.com/silverbucket)
 *
 * sockethub is licensed under the AGPLv3.
 * See the LICENSE file for details.
 *
 * The latest version of sockethub can be found here:
 *   git://github.com/sockethub/sockethub.git
 *
 * For more information about sockethub visit http://sockethub.org/.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 */
var Sockethub = require('./../lib/sockethub/sockethub.js');
var p = require('./../package.json');
var sockethub;

process.on('SIGINT', function () {
  console.log("\n [sockethub] caught SIGINT");
  try {
    sockethub.shutdown();
    process.exit(1);
  } catch (e) {
    console.log(' ERROR: '+e);
    process.exit(1);
  }
});

process.on('SIGTERM', function () {
  console.log("\n [sockethub] caught SIGTERM");
  try {
    sockethub.shutdown();
    process.exit(1);
  } catch (e) {
    console.log(' ERROR: '+e);
    process.exit(1);
  }
});

process.on('uncaughtException', function (err) {
  console.log(' [sockethub] caught exception: ' + err);
  console.log(err.stack);
  process.exit(1);
});


var argv = require ("argp")
    .description ("a polyglot websocket service")
    .email ('https://github.com/sockethub/sockethub/issues')
    .on('end', function(argv) {
      sockethub = Sockethub({
       root: './',
       configFile: argv.config,
       debug: argv.debug,
       log: argv.log,
       output: argv.output,
       sockethubid: argv.sockethubid
      });
      console.log('SOCKETHUB: ', sockethub);
      sockethub.events.on('initialized', function () {
        console.log('sockethub initialization complete');
      });
    })
    .body ()
        //The object an argument definitions and the text of the --help message are
        //configured at the same time
        .text ("\n Options:")
        .option ({ short: "c", long: "config", metavar: "CFG_FILE", description: "location of the config.js"})
        .option ({ short: "d", long: "debug", description: "enable debug output (overrides config file)" })
        .option ({ short: "l", long: "log", metavar: "LOG_FILE", description: "full path for sockethub to log output" })
        .option ({ short: "o", long: "output", description: "outputs logs to console in addition to any logfile" })
        .option ({ short: "s", long: "sockethubid", description: "assign this instance an existing sockethubId, rather than it generating it's own." })
        .help ()
        .usage ()
        .version (p.version)
    .argv ();
